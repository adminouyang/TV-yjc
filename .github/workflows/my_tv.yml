name: my_tv

on:
  schedule:
    - cron: '0 */12 * * *'  # 每6小时运行一次
  workflow_dispatch:  # 支持手动触发

env:
  TZ: 'Asia/Shanghai'
  
permissions:
  contents: write  # 关键：添加写入权限

jobs:
  update-sources:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Create necessary directories
      run: |
        mkdir -p my_tv/ip
        mkdir -p my_tv/template
        mkdir -p my_tv/output
        
    - name: Run IPTV processing script
      run: python my_tv/main.py
    
    - name: List generated files
      run: |
        echo "Generated files in my_tv directory:"
        find my_tv -name "*.txt" -o -name "*.m3u" -exec ls -lh {} \;
        
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "github-actions@github.com"
    
    - name: Get current time
      id: time
      run: |
        echo "date=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
        echo "short_date=$(date '+%Y-%m-%d')" >> $GITHUB_OUTPUT
        echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT
    
    - name: Commit and push
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "自动更新IPTV源 - ${{ steps.time.outputs.date }}"
        commit_options: '--no-verify'
        file_pattern: 'my_tv/* *.txt *.m3u'
        push_options: '--force'
        skip_fetch: true

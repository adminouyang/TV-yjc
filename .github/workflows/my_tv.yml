name: IPTV Source Processor

on:
  # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: '0 18 * * *'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # å½“ä»£ç æ¨é€æ—¶ä¹Ÿè¿è¡Œ
  push:
    branches: [ main ]

jobs:
  process-iptv-sources:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests
        pip install urllib3
        
    - name: åˆ›å»ºå¿…è¦ç›®å½•
      run: |
        mkdir -p my_tv/ip
        mkdir -p my_tv/template
        mkdir -p my_tv/output
        
    - name: è¿è¡ŒIPTVæºå¤„ç†è„šæœ¬
      run: python my_tv/main.py
      continue-on-error: false
      
    - name: æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶
      run: |
        echo "=== ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨ ==="
        ls -la my_tv/output/ || echo "outputç›®å½•ä¸å­˜åœ¨"
        ls -la *.txt *.m3u 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°åˆå¹¶æ–‡ä»¶"
        
    - name: ä¸Šä¼ ç”Ÿæˆçš„è¾“å‡ºæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: iptv-playlists
        path: |
          my_tv/output/
          *.txt
          *.m3u
        retention-days: 7
        
    - name: è‡ªåŠ¨æäº¤ç”Ÿæˆçš„æ–‡ä»¶
      if: github.event_name == 'schedule'
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦æäº¤
        if git status --porcelain | grep -E '\.(txt|m3u)$' || git status --porcelain output/; then
          echo "æœ‰æ–°çš„æ›´æ”¹ï¼Œæ­£åœ¨æäº¤..."
          git add my_tv/output/ *.txt *.m3u
          git commit -m "ğŸ“¡ è‡ªåŠ¨æ›´æ–°IPTVæ’­æ”¾åˆ—è¡¨ - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
        else
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
